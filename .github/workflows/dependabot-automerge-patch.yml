name: Dependabot auto-approve + auto-merge patch updates

on:
  pull_request:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: dependabot-automerge-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  automerge:
    if: >
      github.event.pull_request.user.login == 'dependabot[bot]' &&
      github.event.pull_request.draft == false &&
      github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest

    steps:
      - name: Check for DEPENDABOT_AUTOMERGE_PAT secret
        run: |
          if [ -z "${{ secrets.DEPENDABOT_AUTOMERGE_PAT }}" ]; then
            echo "Error: DEPENDABOT_AUTOMERGE_PAT secret is not set. Exiting." >&2
            exit 1
          fi

      - id: meta
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Approve (patch only)
        if: steps.meta.outputs.update-type == 'version-update:semver-patch'
        run: |
          gh pr review "${{ github.event.pull_request.html_url }}" --approve -b "Auto-approving Dependabot patch update." || { echo "Error: Failed to approve PR." >&2; exit 1; }
        env:
          GH_TOKEN: ${{ secrets.DEPENDABOT_AUTOMERGE_PAT }}

      - name: Enable auto-merge (patch only)
        if: steps.meta.outputs.update-type == 'version-update:semver-patch'
        run: |
          gh pr merge --auto --squash "${{ github.event.pull_request.html_url }}" || { echo "Error: Failed to enable auto-merge." >&2; exit 1; }
        env:
          GH_TOKEN: ${{ secrets.DEPENDABOT_AUTOMERGE_PAT }}
