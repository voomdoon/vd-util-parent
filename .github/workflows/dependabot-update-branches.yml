name: Dependabot update branches

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: dependabot-update-branches
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Update out-of-date Dependabot PRs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DEPENDABOT_AUTOMERGE_PAT }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const base = "main";

            // list open PRs into main
            const prs = await github.paginate(github.rest.pulls.list, {
              owner,
              repo,
              state: "open",
              base,
              per_page: 100,
            });

            const dependabot = prs.filter(pr => pr.user?.login === "dependabot[bot]");
            core.info(`Found ${dependabot.length} open Dependabot PR(s) targeting ${base}.`);

            for (const pr of dependabot) {
              // Only try if GitHub thinks it's behind base.
              // (This avoids noisy API calls.)
              if (!pr.mergeable_state || pr.mergeable_state === "unknown") {
                // mergeable_state can be stale; still okay to try update-branch later.
                core.info(`PR #${pr.number}: mergeable_state=${pr.mergeable_state} (will attempt update)`);
              }

              core.info(`Updating PR #${pr.number}: ${pr.title}`);

              try {
                // Equivalent to clicking "Update branch" in the UI
                await github.request("PUT /repos/{owner}/{repo}/pulls/{pull_number}/update-branch", {
                  owner,
                  repo,
                  pull_number: pr.number,
                  expected_head_sha: pr.head.sha,
                });
                core.info(`✅ Update triggered for PR #${pr.number}`);
              } catch (e) {
                core.warning(`⚠️ Could not update PR #${pr.number}: ${e.status || ""} ${e.message}`);
              }
            }
