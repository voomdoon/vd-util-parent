name: Dependabot auto-merge

on:
  pull_request:

concurrency:
  group: dependabot-automerge-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  check_setup:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Check for DEPENDABOT_AUTOMERGE_PAT secret
        run: |
          if [ -z "${{ secrets.DEPENDABOT_AUTOMERGE_PAT }}" ]; then
            echo "Error: DEPENDABOT_AUTOMERGE_PAT secret is not set. Exiting." >&2
            exit 1
          fi
      - name: "Guard: ensure branch protection requires CI check"
        env:
          GH_TOKEN: ${{ secrets.DEPENDABOT_AUTOMERGE_PAT }}
          EXPECTED_CHECK: verify
          PROTECTED_BRANCH: main
        run: |
          set -euo pipefail
      
          api="repos/${GITHUB_REPOSITORY}/branches/${PROTECTED_BRANCH}/protection/required_status_checks"
          echo "Checking required status checks via: $api"
      
          # capture status code
          out="$(mktemp)"
          code="$(gh api -H "Accept: application/vnd.github+json" "$api" >"$out" 2>/dev/null; echo $?)"
      
          if [ "$code" -ne 0 ]; then
            echo "ERROR: Cannot read branch protection required status checks." >&2
            echo "Likely causes:" >&2
            echo " - PAT lacks fine-grained permission: Administration (read-only)" >&2
            echo " - Token owner is not repo admin" >&2
            exit 1
          fi
      
          contexts="$(jq -r '.contexts[]?' <"$out")"
      
          if [ -z "$contexts" ]; then
            echo "ERROR: No required status checks configured on ${PROTECTED_BRANCH}." >&2
            exit 1
          fi
      
          if ! echo "$contexts" | grep -Fxq "$EXPECTED_CHECK"; then
            echo "ERROR: Required checks do NOT include '${EXPECTED_CHECK}'." >&2
            echo "Required checks are:" >&2
            echo "$contexts" | sed 's/^/ - /'
            exit 1
          fi

          echo "OK: Branch protection requires '${EXPECTED_CHECK}'."

  approve:
    needs: check_setup
    if: >
      github.event.pull_request.user.login == 'dependabot[bot]' &&
      github.event.pull_request.draft == false &&
      github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    outputs:
      should_automerge: ${{ steps.policy.outputs.should_automerge }}

    steps:
      - id: meta
        name: Fetch metadata 
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - id: policy
        name: Decide auto-merge policy
        run: |
          SHOULD="false"

          UPDATE_TYPE="${{ steps.meta.outputs.update-type }}"
          ECO="${{ steps.meta.outputs.package-ecosystem }}"

          # allow: any patch
          if [ "$UPDATE_TYPE" = "version-update:semver-patch" ]; then
            SHOULD="true"
          fi

          # allow: github-actions minor (and patch already covered above)
          if [ "$ECO" = "github_actions" ] && [ "$UPDATE_TYPE" = "version-update:semver-minor" ]; then
            SHOULD="true"
          fi

          echo "should_automerge=$SHOULD" >> "$GITHUB_OUTPUT"

      - name: Approve Dependabot PR
        if: steps.policy.outputs.should_automerge == 'true'
        run: gh pr review "${{ github.event.pull_request.html_url }}" --approve -b "Auto-approving Dependabot update."
        env:
          GH_TOKEN: ${{ secrets.DEPENDABOT_AUTOMERGE_PAT }}

  automerge:
    needs: approve
    if: needs.approve.outputs.should_automerge == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Enable auto-merge
        run: |
          gh pr merge --auto --squash "${{ github.event.pull_request.html_url }}" || { echo "Error: Failed to enable auto-merge." >&2; exit 1; }
        env:
          GH_TOKEN: ${{ secrets.DEPENDABOT_AUTOMERGE_PAT }}